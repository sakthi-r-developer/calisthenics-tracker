<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Calisthenics Roadmap — Progress Tracker</title>
  <style>
    :root{
      --accent:#2b8cff;
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9aa7b2;
      --glass: rgba(255,255,255,0.03);
      --radius:12px;
      color-scheme: dark;
    }
    *{box-sizing:border-box}
    html,body{height:100%;}
    body{
      margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;
      background:linear-gradient(180deg, #071024 0%, #05111a 100%); color:#e6f0f6;
      padding:18px;
    }
    header{display:flex;align-items:center;gap:12px;margin-bottom:16px}
    .brand {font-weight:700;font-size:18px; color:var(--accent)}
    .container{display:flex;gap:16px;align-items:flex-start}
    .sidebar{
      width:260px; background:var(--card); border-radius:var(--radius); padding:12px;
      box-shadow: 0 6px 20px rgba(2,6,23,0.6);
    }
    .levels{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
    .level-btn{padding:8px;border-radius:8px;text-align:center;cursor:pointer;background:var(--glass);border:1px solid rgba(255,255,255,0.03)}
    .level-btn.active{background:linear-gradient(90deg,var(--accent),#6fb0ff);color:#042033;font-weight:700}
    .card{flex:1;background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 8px 30px rgba(2,6,23,0.5)}
    .row{display:flex;gap:12px;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    .stat{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;flex:1}
    .exercise{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));padding:12px;border-radius:10px;margin-bottom:8px}
    input[type="number"], input[type="text"]{width:70px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    button{cursor:pointer;padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:#042033;font-weight:700}
    .link-like{background:none;border:0;color:var(--accent);padding:6px;cursor:pointer}
    .small{font-size:13px}
    .history-item{padding:8px;border-radius:8px;margin-bottom:8px;background:rgba(255,255,255,0.02);display:flex;justify-content:space-between}
    footer{margin-top:14px;color:var(--muted);font-size:13px}
    @media (max-width:880px){
      .container{flex-direction:column}
      .sidebar{width:100%}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">Calisthenics Roadmap — Progress</div>
    <div class="muted">Personal tracker · Local storage · Export/Import backup</div>
  </header>

  <div class="container">
    <aside class="sidebar">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
        <div>
          <div class="small muted">Current level</div>
          <div id="currentLevelLabel" style="font-weight:700;font-size:20px">Level 1</div>
        </div>
        <div style="text-align:right">
          <div class="muted small">XP</div>
          <div id="xpLabel" style="font-weight:700">0</div>
        </div>
      </div>

      <div style="margin-bottom:10px">
        <div class="muted small">Select level</div>
        <div class="levels" id="levelsGrid"></div>
      </div>

      <div style="margin-top:12px">
        <div class="muted small">Streak</div>
        <div id="streakLabel" style="font-weight:700;font-size:18px">0 days</div>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="exportBtn" class="small">Export JSON</button>
        <button id="importBtn" class="small">Import JSON</button>
        <input type="file" id="importFile" style="display:none" accept="application/json"/>
      </div>

      <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0"/>

      <div class="muted small">Recent logs</div>
      <div id="historyList" style="margin-top:8px;max-height:280px;overflow:auto"></div>

      <footer>
        Pro tip: press your level number to switch training missions.
      </footer>
    </aside>

    <main class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div>
          <div class="muted small">Today's focus</div>
          <div id="todayTitle" style="font-weight:700;font-size:20px">Foundation — Level 1</div>
          <div id="todayDates" class="muted small">Week 1</div>
        </div>
        <div style="text-align:right">
          <div class="muted small">Level Progress</div>
          <div style="display:flex;gap:8px;align-items:center">
            <progress id="levelProgress" value="0" max="100" style="height:12px;border-radius:8px;width:180px;"></progress>
            <div id="progressPct" style="font-weight:700">0%</div>
          </div>
        </div>
      </div>

      <div id="exercisesWrap"></div>

      <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
        <button id="saveLogBtn">Save log (today)</button>
        <button id="testDayBtn" class="link-like small">Record test / max reps</button>
        <button id="clearDataBtn" class="link-like small" title="Reset all local data">Reset local data</button>
      </div>
    </main>
  </div>

  <script>
/* -------------------------
   Data model & roadmap seed
   ------------------------- */
const STORAGE_KEY = 'calisthenics_progress_v1';
    const roadmap = {
  1: { title:'Foundation Phase (Level 1)', weekRange:'Week 1', exercises:[
    {name:'Wall/Knee Push-ups', sets:3, type:'reps', setsDefault:[8,8,8]},
    {name:'Chair Squats', sets:3, type:'reps', setsDefault:[10,10,10]},
    {name:'Plank', sets:3, type:'hold', setsDefault:[15,15,15]},
    {name:'Dead Hang', sets:3, type:'hold', setsDefault:[10,10,10]},
  ]},

  2: { title:'Foundation Phase (Level 2)', weekRange:'Weeks 2–3', exercises:[
    {name:'Incline Push-ups', sets:3, type:'reps', setsDefault:[10,10,10]},
    {name:'Bodyweight Squats', sets:3, type:'reps', setsDefault:[15,15,15]},
    {name:'Side Plank', sets:2, type:'hold', side:true, setsDefault:[10,10]},
    {name:'Assisted Pull-ups', sets:3, type:'reps', setsDefault:[5,5,5]},
  ]},

  3: { title:'Foundation Phase (Level 3)', weekRange:'Weeks 4–6', exercises:[
    {name:'Full Push-ups', sets:4, type:'reps', setsDefault:[8,8,9,9]},
    {name:'Squats', sets:4, type:'reps', setsDefault:[15,15,15,15]},
    {name:'Plank', sets:3, type:'hold', setsDefault:[30,30,30]},
    {name:'Negative Pull-ups', sets:4, type:'reps', setsDefault:[5,5,5,5]},
  ]},

  4: { title:'Foundation Phase (Level 4)', weekRange:'Weeks 7–10', exercises:[
    {name:'Dips (bench)', sets:3, type:'reps', setsDefault:[10,10,10]},
    {name:'Split Squats', sets:3, type:'reps', side:true, setsDefault:[10,10,10]},
    {name:'Hollow Hold', sets:3, type:'hold', setsDefault:[15,15,15]},
    {name:'Assisted Pull-ups', sets:4, type:'reps', setsDefault:[6,6,6,6]},
  ]},

  5: { title:'Foundation Phase (Level 5)', weekRange:'Weeks 11–13', exercises:[
    {name:'Push-ups', sets:4, type:'reps', setsDefault:[15,15,15,15]},
    {name:'Squats', sets:4, type:'reps', setsDefault:[20,20,20,20]},
    {name:'Dips (bench/parallel)', sets:3, type:'reps', setsDefault:[12,12,12]},
    {name:'Pull-ups (full or assisted)', sets:4, type:'reps', setsDefault:[6,6,7,7]},
    {name:'Plank/Hollow', sets:3, type:'hold', setsDefault:[45,45,45]},
  ]},

  6: { title:'Foundation Phase (Level 6)', weekRange:'Weeks 14–16', exercises:[
    {name:'Push-ups', sets:4, type:'reps', setsDefault:[15,15,15,16]},
    {name:'Squats', sets:4, type:'reps', setsDefault:[20,20,20,20]},
    {name:'Dips', sets:3, type:'reps', setsDefault:[12,12,12]},
    {name:'Pull-ups', sets:4, type:'reps', setsDefault:[6,7,7,8]},
    {name:'Plank/Hollow', sets:3, type:'hold', setsDefault:[50,50,50]},
  ]},

  7: { title:'Foundation Phase (Level 7)', weekRange:'Weeks 17–20', exercises:[
    {name:'Push-ups', sets:4, type:'reps', setsDefault:[16,16,16,16]},
    {name:'Squats', sets:4, type:'reps', setsDefault:[22,22,22,22]},
    {name:'Dips', sets:3, type:'reps', setsDefault:[12,12,12]},
    {name:'Pull-ups', sets:4, type:'reps', setsDefault:[7,7,8,8]},
    {name:'Plank/Hollow', sets:3, type:'hold', setsDefault:[55,55,55]},
  ]},

  8: { title:'Foundation Phase (Level 8)', weekRange:'Weeks 21–28', exercises:[
    {name:'Push-ups', sets:4, type:'reps', setsDefault:[15,15,15,18]},
    {name:'Squats', sets:4, type:'reps', setsDefault:[20,20,22,22]},
    {name:'Dips (bench/parallel)', sets:3, type:'reps', setsDefault:[12,12,12]},
    {name:'Pull-ups (full or assisted)', sets:4, type:'reps', setsDefault:[6,7,8,8]},
    {name:'Plank/Hollow', sets:3, type:'hold', setsDefault:[60,60,60]},
  ]},

  9: { title:'Skill Unlock Phase (Level 9) — Crow/Frog', weekRange:'Weeks 29–30', exercises:[
    {name:'Push-ups', sets:4, type:'reps', setsDefault:[15,15,15,15]},
    {name:'Squats', sets:4, type:'reps', setsDefault:[20,20,20,20]},
    {name:'Pull-ups', sets:4, type:'reps', setsDefault:[8,8,8,8]},
    {name:'Crow Pose / Frog Stand', sets:5, type:'hold', setsDefault:[10,10,10,10,10]},
  ]},

  10: { title:'Skill Unlock (Level 10) — Pike Push-ups', weekRange:'Weeks 31–33', exercises:[
    {name:'Pike Push-ups', sets:4, type:'reps', setsDefault:[8,8,9,9]},
    {name:'Dips', sets:4, type:'reps', setsDefault:[10,10,10,10]},
    {name:'Pull-ups', sets:4, type:'reps', setsDefault:[8,8,8,8]},
    {name:'Hollow Hold', sets:3, type:'hold', setsDefault:[30,30,30]},
  ]},

  11: { title:'Skill Unlock (Level 11) — L-sit (tuck)', weekRange:'Weeks 34–36', exercises:[
    {name:'Push-ups', sets:4, type:'reps', setsDefault:[20,20,20,20]},
    {name:'Squats', sets:4, type:'reps', setsDefault:[25,25,25,25]},
    {name:'L-sit (tuck) holds', sets:5, type:'hold', setsDefault:[10,10,10,10,10]},
    {name:'Hanging Knee Raises', sets:3, type:'reps', setsDefault:[10,10,10]},
  ]},

  12: { title:'Skill Unlock (Level 12) — Archer Push-ups prep', weekRange:'Weeks 37–40', exercises:[
    {name:'Archer Push-ups', sets:3, type:'reps', setsDefault:[6,6,7]},
    {name:'Dips', sets:3, type:'reps', setsDefault:[12,12,12]},
    {name:'Pull-ups', sets:4, type:'reps', setsDefault:[10,10,10,10]},
    {name:'Plank → Side Plank transitions', sets:3, type:'hold', setsDefault:[30,30,30]},
  ]},

  13: { title:'Skill Unlock (Level 13) — Skin the Cat', weekRange:'Weeks 41–45', exercises:[
    {name:'Pull-ups', sets:4, type:'reps', setsDefault:[8,8,8,8]},
    {name:'Dips', sets:3, type:'reps', setsDefault:[12,12,12]},
    {name:'Skin the Cat', sets:5, type:'reps', setsDefault:[3,3,3,3,3]},
    {name:'Hollow Rocks', sets:3, type:'reps', setsDefault:[12,12,12]},
  ]},

  14: { title:'Skill Unlock (Level 14) — Handstand (wall)', weekRange:'Weeks 46–51', exercises:[
    {name:'Handstand holds (wall)', sets:5, type:'hold', setsDefault:[20,20,20,20,20]},
    {name:'Pike Push-ups', sets:4, type:'reps', setsDefault:[10,10,10,10]},
    {name:'Squats', sets:4, type:'reps', setsDefault:[25,25,25,25]},
    {name:'Core circuit (L-sit + Hollow + Side plank)', sets:3, type:'hold', setsDefault:[30,30,30]},
  ]},

  15: { title:'Skill Unlock (Level 15) — Pistol Squat', weekRange:'Weeks 52–58', exercises:[
    {name:'Assisted Pistol', sets:5, type:'reps', side:true, setsDefault:[5,5,5,5,5]},
    {name:'Squats', sets:3, type:'reps', setsDefault:[20,20,20]},
    {name:'Pull-ups', sets:4, type:'reps', setsDefault:[10,10,10,10]},
    {name:'L-sit', sets:4, type:'hold', setsDefault:[15,15,15,15]},
  ]},

  16: { title:'Skill Unlock (Level 16) — Toes-to-Bar', weekRange:'Weeks 59–66', exercises:[
    {name:'Hanging Leg Raises → Toes-to-Bar', sets:4, type:'reps', setsDefault:[6,6,7,7]},
    {name:'Pull-ups', sets:4, type:'reps', setsDefault:[10,10,10,10]},
    {name:'Dips', sets:4, type:'reps', setsDefault:[12,12,12,12]},
    {name:'Core Hollow Hold', sets:4, type:'hold', setsDefault:[30,30,30,30]},
  ]},

  17: { title:'Skill Unlock (Level 17) — Front Lever (Tuck)', weekRange:'Weeks 67–75', exercises:[
    {name:'Front Lever Tuck Hold', sets:5, type:'hold', setsDefault:[5,5,5,5,5]},
    {name:'Pull-ups', sets:4, type:'reps', setsDefault:[10,10,10,10]},
    {name:'Rows (inverted)', sets:4, type:'reps', setsDefault:[12,12,12,12]},
    {name:'Hollow Rocks', sets:3, type:'reps', setsDefault:[15,15,15]},
  ]},

  18: { title:'Skill Unlock (Level 18) — One-Arm Push-up prep', weekRange:'Weeks 76–85', exercises:[
    {name:'One-Arm Push-up (elevated)', sets:4, type:'reps', side:true, setsDefault:[5,5,5,5]},
    {name:'Archer Push-ups', sets:3, type:'reps', setsDefault:[8,8,8]},
    {name:'Dips', sets:4, type:'reps', setsDefault:[12,12,12,12]},
    {name:'Squats', sets:4, type:'reps', setsDefault:[25,25,25,25]},
  ]},

  19: { title:'Skill Unlock (Level 19) — Back Lever (Tuck→Straddle)', weekRange:'Weeks 86–96', exercises:[
    {name:'Back Lever Tuck', sets:5, type:'hold', setsDefault:[5,5,5,5,5]},
    {name:'Pull-ups', sets:4, type:'reps', setsDefault:[8,8,8,8]},
    {name:'Skin the Cat', sets:3, type:'reps', setsDefault:[5,5,5]},
    {name:'Core Circuit (Hollow + L-sit + Leg Raises)', sets:3, type:'hold', setsDefault:[30,30,30]},
  ]},

  20: { title:'Skill Unlock (Level 20) — Muscle-Up (Final Boss)', weekRange:'Weeks 97–120', exercises:[
    {name:'Explosive Pull-ups', sets:4, type:'reps', setsDefault:[6,6,6,6]},
    {name:'Transition drills', sets:5, type:'reps', setsDefault:[3,3,3,3,3]},
    {name:'Dips (straight bar)', sets:4, type:'reps', setsDefault:[8,8,8,8]},
    {name:'Core (Toes-to-Bar or Front Lever Tuck)', sets:3, type:'reps', setsDefault:[8,8,8]},
  ]},
};




// Auto-generate placeholder levels beyond 20 if needed
for(let i=21;i<=30;i++){
  if(!roadmap[i]){
    roadmap[i] = {
      title:`Extra Level ${i}`,
      weekRange:'Custom progression',
      exercises:[
        {name:'Push-ups', sets:4, type:'reps', setsDefault:[20,20,20,20]},
        {name:'Squats', sets:4, type:'reps', setsDefault:[25,25,25,25]},
        {name:'Skill practice', sets:3, type:'reps', setsDefault:[10,10,10]},
        {name:'Core hold', sets:3, type:'hold', setsDefault:[60,60,60]},
      ]
    };
  }
}


/* -------------------------
   Persistence helpers
   ------------------------- */
function defaultData(){
  return {
    profile:{ name:'', currentLevel:1, xp:0, startDate: new Date().toISOString().slice(0,10) },
    logs: {}, // keyed by YYYY-MM-DD
    pbs: {},  // e.g. { "Full Push-ups": 12, "Plank": 60 }
  };
}

function loadData(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultData();
    return JSON.parse(raw);
  }catch(e){
    console.error('load error',e);
    return defaultData();
  }
}
function saveData(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* -------------------------
   XP / PB / Streak logic
   ------------------------- */
// Simple XP rules (configurable)
function xpForReps(reps){ return reps * 10; }      // each rep = 10 XP
function xpForHold(sec){ return Math.round(sec * 1); } // each second = 1 XP
function computeXpFromExercise(ex){
  // ex: {type:'reps'|'hold', repsPerSet:[..], holdPerSet:[..]}
  let xp=0;
  if(ex.type==='reps'){
    for(let r of ex.values) xp += xpForReps(Number(r)||0);
  }else{
    for(let s of ex.values) xp += xpForHold(Number(s)||0);
  }
  return xp;
}

function updatePBsFromLog(date, savedExercises){
  // savedExercises: array of {name,type,values:[]}
  for(const e of savedExercises){
    const name = e.name;
    if(!name) continue;
    // For holds: take max seconds. For reps: take max reps.
    const newBest = e.values.reduce((a,b)=> Math.max(a, Number(b)||0), 0);
    const old = state.pbs[name] || 0;
    if(newBest > old){
      state.pbs[name] = newBest;
    }
  }
}

/* Streak: consecutive days with saved logs up to 'today' */
function computeStreak(){
  const logs = Object.keys(state.logs).sort();
  if(logs.length === 0) return 0;
  // count backwards from today
  const today = new Date();
  let streak = 0;
  for(let i=0;;i++){
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const key = d.toISOString().slice(0,10);
    if(state.logs[key]) streak++;
    else break;
  }
  return streak;
}

/* -------------------------
   UI render & wiring
   ------------------------- */
let state = loadData();
const levelsGrid = document.getElementById('levelsGrid');
const currentLevelLabel = document.getElementById('currentLevelLabel');
const xpLabel = document.getElementById('xpLabel');
const streakLabel = document.getElementById('streakLabel');
const exercisesWrap = document.getElementById('exercisesWrap');
const todayTitle = document.getElementById('todayTitle');
const todayDates = document.getElementById('todayDates');
const levelProgress = document.getElementById('levelProgress');
const progressPct = document.getElementById('progressPct');
const historyList = document.getElementById('historyList');

function renderLevels(){
  levelsGrid.innerHTML = '';
  for(let i=1;i<=20;i++){
    const btn = document.createElement('button');
    btn.className = 'level-btn';
    btn.innerText = i;
    if(state.profile.currentLevel === i) btn.classList.add('active');
    btn.onclick = ()=> {
      state.profile.currentLevel = i;
      saveData(); renderAll();
    };
    levelsGrid.appendChild(btn);
  }
}
function renderDashboard(){
  currentLevelLabel.innerText = `Level ${state.profile.currentLevel}`;
  xpLabel.innerText = `${state.profile.xp} XP`;
  streakLabel.innerText = `${computeStreak()} days`;
  // progress: simple percentage toward next level (you can customize formula)
  const baseForLevel = (state.profile.currentLevel - 1) * 1000;
  const nextForLevel = state.profile.currentLevel * 1000;
  const xp = state.profile.xp;
  const pct = Math.min(100, Math.round((xp - baseForLevel) / (nextForLevel-baseForLevel) * 100));
  levelProgress.value = pct;
  progressPct.innerText = `${pct}%`;
}

function renderTodayWorkout(){
  const lv = state.profile.currentLevel;
  const info = roadmap[lv] || roadmap[1];
  todayTitle.innerText = info.title || `Level ${lv}`;
  todayDates.innerText = info.weekRange || '';
  exercisesWrap.innerHTML = '';

  // Build UI for each exercise
  info.exercises.forEach((ex, idx) => {
    const wrap = document.createElement('div');
    wrap.className = 'exercise';
    const title = document.createElement('div');
    title.style.display='flex';
    title.style.justifyContent='space-between';
    title.innerHTML = `<div style="font-weight:700">${ex.name}</div><div class="muted small">${ex.type==='hold'?'hold (s)':'reps'}</div>`;
    wrap.appendChild(title);

    // per-set inputs
    const setsRow = document.createElement('div');
    setsRow.style.display='flex';
    setsRow.style.gap='8px';
    setsRow.style.marginTop='8px';
    const defaultValues = ex.setsDefault || Array(ex.sets).fill(0);
    for(let s=0;s<ex.sets;s++){
      const col = document.createElement('div');
      col.style.display='flex'; col.style.flexDirection='column'; col.style.alignItems='center';
      const label = document.createElement('div');
      label.className='small muted'; label.innerText = `S${s+1}`;
      const input = document.createElement('input');
      input.type = 'number';
      input.min = 0;
      input.value = defaultValues[s] || 0;
      input.dataset.exName = ex.name;
      input.dataset.idx = s;
      input.dataset.exType = ex.type;
      input.style.width='68px';
      col.appendChild(label); col.appendChild(input);
      setsRow.appendChild(col);
    }
    wrap.appendChild(setsRow);
    exercisesWrap.appendChild(wrap);
  });

  // Save button handling is global
}

function collectExercisesFromUI(){
  const inputs = exercisesWrap.querySelectorAll('input[type="number"]');
  const map = {}; // name -> values array
  inputs.forEach(inp=>{
    const name = inp.dataset.exName;
    if(!map[name]) map[name]= {name, type: inp.dataset.exType, values: []};
    map[name].values[Number(inp.dataset.idx)] = Number(inp.value || 0);
  });
  return Object.values(map);
}

/* -------------------------
   Buttons & file actions
   ------------------------- */
document.getElementById('saveLogBtn').addEventListener('click', ()=>{
  const today = new Date().toISOString().slice(0,10);
  const list = collectExercisesFromUI();
  const xpGain = list.reduce((a,c)=> a + computeXpFromExercise(c), 0);
  // save to logs
  state.logs[today] = {
    date: today,
    level: state.profile.currentLevel,
    exercises: list,
    xpEarned: xpGain,
    note: ''
  };
  // update state xp & pbs
  state.profile.xp = (state.profile.xp || 0) + xpGain;
  updatePBsFromLog(today, list);
  saveData();
  renderAll();
  alert(`Saved ${today}. +${xpGain} XP`);
});

document.getElementById('testDayBtn').addEventListener('click', ()=>{
  const name = prompt('Which exercise to record max reps/time for? (e.g., Pull-ups, Full Push-ups, Plank)');
  if(!name) return;
  const val = prompt('Enter best number (reps or seconds). Example: 12 or 40');
  const num = Number(val || 0);
  if(!num || num<=0) { alert('Invalid number'); return; }
  const today = new Date().toISOString().slice(0,10);
  state.logs[today] = state.logs[today] || {date:today, level: state.profile.currentLevel, exercises: [], xpEarned:0, note:''};
  state.logs[today].exercises.push({name, type: Number.isInteger(num) ? 'reps':'hold', values:[num]});
  // xp reward: generous for tests
  const xpGain = Math.round(num * 15);
  state.logs[today].xpEarned += xpGain;
  state.profile.xp = (state.profile.xp || 0) + xpGain;
  updatePBsFromLog(today, state.logs[today].exercises);
  saveData(); renderAll();
  alert(`Test recorded. +${xpGain} XP`);
});

document.getElementById('clearDataBtn').addEventListener('click', ()=>{
  if(!confirm('Reset all local data? This will erase logs and PBs on this device.')) return;
  state = defaultData(); saveData(); renderAll();
});

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'calisthenics_progress.json';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  try{
    const txt = await f.text();
    const imported = JSON.parse(txt);
    if(!confirm('Merge imported data into your current data? Cancel=replace')) {
      // replace
      state = imported;
    } else {
      // merge logs & pbs & xp
      state.logs = {...state.logs, ...imported.logs};
      state.pbs = {...state.pbs, ...imported.pbs};
      state.profile.xp = Math.max(state.profile.xp || 0, imported.profile?.xp || 0);
    }
    saveData(); renderAll();
    alert('Import complete.');
  }catch(err){
    alert('Import failed: ' + err.message);
  } finally {
    e.target.value = '';
  }
});

/* -------------------------
   History UI
   ------------------------- */
function renderHistory(){
  historyList.innerHTML = '';
  const keys = Object.keys(state.logs).sort((a,b)=> b.localeCompare(a)).slice(0,30);
  if(keys.length===0){
    historyList.innerHTML = `<div class="muted small">No logs yet — start training and save your first log.</div>`;
    return;
  }
  for(const k of keys){
    const item = state.logs[k];
    const div = document.createElement('div');
    div.className = 'history-item';
    const left = document.createElement('div');
    left.innerHTML = `<div style="font-weight:700">${k}</div><div class="muted small">Level ${item.level} · ${item.exercises.length} exercises</div>`;
    const right = document.createElement('div');
    right.style.textAlign='right';
    right.innerHTML = `<div style="font-weight:700">${item.xpEarned} XP</div><div class="muted small">${(item.note||'')}</div>`;
    div.appendChild(left); div.appendChild(right);
    div.onclick = ()=> {
      // quick show details
      const detail = item.exercises.map(e => `${e.name}: ${e.values.join(', ')}`).join('\\n');
      alert(k + '\\n\\n' + detail + '\\n\\nXP: ' + item.xpEarned);
    };
    historyList.appendChild(div);
  }
}

/* -------------------------
   Overall render
   ------------------------- */
function renderAll(){
  renderLevels();
  renderDashboard();
  renderTodayWorkout();
  renderHistory();
}

// initial render
renderAll();

  </script>
</body>
</html>
